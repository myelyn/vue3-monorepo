{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/reactiveEffect.ts", "../src/baseHandlers.ts", "../src/reactive.ts"],
  "sourcesContent": ["export let activeEffect\n\n\nexport const effect = (fn) => {\n  const _effect = new ReactiveEffect(fn, () => {\n    _effect.run()\n  })\n  _effect.run()\n  return _effect\n}\n\nexport const preCleanEffect = (effect) => {\n  effect._depsLength = 0\n  effect._trackId++\n}\n\nexport const cleanDepEffect = (dep, effect) => {\n  dep.delete(effect)\n  if (!dep.size) {\n    dep.cleanup()\n  }\n}\n\nexport const postCleanEffect = (effect) => {\n  if (effect.deps.length > effect._depsLength) {\n    effect.deps.length = effect._depsLength\n  }\n}\n\nclass ReactiveEffect {\n  _trackId = 0 // run\u51FD\u6570\u6267\u884C\u7684\u6B21\u6570\n  deps = []\n  _depsLength = 0\n  constructor(public fn, public scheduler) {}\n  run() {\n    let lastEffect = activeEffect\n    try {\n      activeEffect = this\n      preCleanEffect(this)\n      return this.fn()\n    } finally {\n      postCleanEffect(this) // \u65E7\u5C5E\u6027\u6BD4\u65B0\u5C5E\u6027\u591A\uFF0C\u8FDB\u884C\u9010\u4E2A\u66F4\u65B0\u4E4B\u540E\uFF0C\u8FD8\u8981\u5220\u9664\u591A\u4F59\u7684\n      activeEffect = lastEffect\n    }\n  }\n}\n\nexport const trackEffect = (effect, dep) => {\n  // \u9996\u5148\u66F4\u65B0\u6620\u5C04\u8868\u3002\u5982\u679C_trackId\u76F8\u540C\uFF0C\u5219\u8BF4\u660E\u6B64\u6B21effect\u6267\u884C\u8FC7\u7A0B\u4E2D\uFF0C\u8BE5\u5C5E\u6027\u5DF2\u7ECF\u6536\u96C6\u8FC7\u4E86\uFF0C\u8DF3\u8FC7\u672C\u6B21\u6536\u96C6\n  if (effect._trackId !== dep.get(effect)) {\n    // \u5982\u679C\u4E4B\u524D\u6620\u5C04\u8868\u4E2D\u4E0D\u5B58\u5728\u8BE5effect\uFF0C\u6216trackId\u4E0D\u540C\uFF0C\u5219\u66F4\u65B0\u6620\u5C04\u8868\n    dep.set(effect, effect._trackId)\n    // \u4E0E\u53CC\u5411\u8BB0\u5FC6\u4E2D\u7684deps\u9010\u4E2A\u6BD4\u8F83,\u627E\u51FA\u65E7\u7684\u65E0\u7528\u7684\u5C5E\u6027\uFF0C\u4ECE\u6620\u5C04\u8868\u4E2D\u6E05\u9664\u3002\u76F8\u540C\u5C5E\u6027\u5219\u8DF3\u8FC7\n    const oldDep = effect.deps[effect._depsLength]\n    if (oldDep !== dep) {\n      oldDep && cleanDepEffect(oldDep, effect)\n      effect.deps[effect._depsLength++] = dep\n    } else {\n      effect._depsLength++\n    }\n  } else {\n    console.log('\u76F8\u540C\u7684\u5C5E\u6027\u4E0D\u5E94\u8BE5\u91CD\u590D\u6536\u96C6')\n  }\n}\n\nexport const triggerEffect = ((dep) => {\n  for(const effect of dep.keys()) {\n    if (effect.scheduler) {\n      effect.scheduler()\n    }\n  }\n})", "export function isObject(value) {\n  return typeof value === \"object\" && value !== null\n}", "import { activeEffect, trackEffect, triggerEffect } from \"./effect\"\n\nconst targetMap = new WeakMap()\n\nexport const createDeps = (cleanup, key) => {\n  const dep = new Map() as any\n  dep.cleanup = cleanup\n  dep.key = key\n  return dep\n}\n\nexport function track(target, key) {\n  if (!activeEffect) {\n    return\n  }\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()))\n  }\n  let dep = depsMap.get(key)\n  if (!dep) {\n    depsMap.set(\n      key, \n      (dep = createDeps(() => depsMap.delete(key), key)) // \u4E3Adeps\u7ED1\u5B9Acleanup\u65B9\u6CD5\u7528\u4E8E\u6E05\u7406\u4E0D\u9700\u8981\u7684\u5C5E\u6027\n    )\n  }\n  trackEffect(activeEffect, dep)\n}\n\nexport function trigger(target, key) {\n  const depsMap = targetMap.get(target)\n  if (!depsMap) {\n    return\n  }\n  let dep = depsMap.get(key)\n  if (!dep) {\n    return\n  }\n  triggerEffect(dep)\n}", "import { ReactiveFlags } from \"./constants\"\nimport { track, trigger } from \"./reactiveEffect\"\n\nexport const mutableHandlers: ProxyHandler<any> = {\n  get(target, key, receiver) {\n    if (key === ReactiveFlags.isReactive) {\n      return true\n    }\n    track(target, key)\n    return Reflect.get(target, key, receiver)\n  },\n  set(target, key, value, receiver) {\n    let oldValue = target[key]\n    const result = Reflect.set(target, key, value, receiver)\n    if (oldValue !== value) {\n      trigger(target, key) \n    }\n    return result\n  }\n}", "import { isObject } from \"@vue/shared\"\nimport { ReactiveFlags } from \"./constants\"\nimport { mutableHandlers } from \"./baseHandlers\"\n\n// \u4EE3\u7406\u5BF9\u8C61\u7684\u7F13\u5B58\nconst reactiveMap = new WeakMap()\nfunction createReactiveObject(target) {\n  // \u53EA\u80FD\u4EE3\u7406\u5BF9\u8C61\uFF0C\u4E0D\u662F\u5BF9\u8C61\u7684\u8BDD\u539F\u6837\u8FD4\u56DE\n  if (!isObject(target)) {\n    return target\n  }\n  // \u5DF2\u7ECF\u88AB\u4EE3\u7406\u8FC7\u4E86\uFF0C\u4F20\u5165\u7684\u662F\u88AB\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61\uFF0C\u539F\u6837\u8FD4\u56DE\n  if (target[ReactiveFlags.isReactive]) {\n    return target\n  }\n  // \u5DF2\u7ECF\u88AB\u4EE3\u7406\u8FC7\u4E86\uFF0C\u4F20\u5165\u7684\u662F\u539F\u5BF9\u8C61\uFF0C\u53D6\u7F13\u5B58\n  const existProxy = reactiveMap.get(target)\n  if (existProxy) {\n    return existProxy\n  }\n  const proxy = new Proxy(target, mutableHandlers)\n  // \u7F13\u5B58\u4EE3\u7406\u5BF9\u8C61\n  reactiveMap.set(target, proxy)\n  return proxy\n}\n\nexport function reactive (target) {\n  return createReactiveObject(target)\n}"],
  "mappings": "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",
  "names": ["effect"]
}
